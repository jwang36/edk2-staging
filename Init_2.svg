<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1655px" preserveAspectRatio="none" style="width:517px;height:1655px;" version="1.1" viewBox="0 0 517 1655" width="517px" zoomAndPan="magnify"><defs><filter height="300%" id="f1ag2d89ez7vo3" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f1ag2d89ez7vo3)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="444" y="99.3125"/><rect fill="#FFFFFF" filter="url(#f1ag2d89ez7vo3)" height="1510.3594" style="stroke:#000000;stroke-width:2.0;" width="493.5" x="10" y="58.6094"/><rect fill="#FFFFFF" filter="url(#f1ag2d89ez7vo3)" height="1330.6016" style="stroke:#000000;stroke-width:2.0;" width="420" x="20" y="231.3672"/><rect fill="#FFFFFF" height="116.5391" style="stroke:none;stroke-width:1.0;" width="420" x="20" y="274.7188"/><rect fill="#FFFFFF" filter="url(#f1ag2d89ez7vo3)" height="18.3516" style="stroke:#000000;stroke-width:2.0;" width="256" x="70" y="340.9063"/><rect fill="#FFFFFF" height="320.2656" style="stroke:none;stroke-width:1.0;" width="420" x="20" y="391.2578"/><rect fill="#FFFFFF" filter="url(#f1ag2d89ez7vo3)" height="265.4297" style="stroke:#000000;stroke-width:2.0;" width="372" x="40" y="414.0938"/><rect fill="#FFFFFF" height="148.8906" style="stroke:none;stroke-width:1.0;" width="372" x="40" y="457.4453"/><rect fill="#FFFFFF" filter="url(#f1ag2d89ez7vo3)" height="61.7031" style="stroke:#000000;stroke-width:2.0;" width="352" x="50" y="480.2813"/><rect fill="#FFFFFF" filter="url(#f1ag2d89ez7vo3)" height="18.3516" style="stroke:#000000;stroke-width:2.0;" width="256" x="70" y="555.9844"/><rect fill="#FFFFFF" height="73.1875" style="stroke:none;stroke-width:1.0;" width="372" x="40" y="606.3359"/><rect fill="#FFFFFF" filter="url(#f1ag2d89ez7vo3)" height="18.3516" style="stroke:#000000;stroke-width:2.0;" width="277" x="70" y="629.1719"/><rect fill="#FFFFFF" height="850.4453" style="stroke:none;stroke-width:1.0;" width="420" x="20" y="711.5234"/><rect fill="#FFFFFF" filter="url(#f1ag2d89ez7vo3)" height="820.6094" style="stroke:#000000;stroke-width:2.0;" width="400" x="30" y="734.3594"/><rect fill="#FFFFFF" height="237.9141" style="stroke:none;stroke-width:1.0;" width="400" x="30" y="777.7109"/><rect fill="#FFFFFF" filter="url(#f1ag2d89ez7vo3)" height="183.0781" style="stroke:#000000;stroke-width:2.0;" width="317" x="40" y="800.5469"/><rect fill="#FFFFFF" height="91.5391" style="stroke:none;stroke-width:1.0;" width="317" x="40" y="843.8984"/><rect fill="#FFFFFF" filter="url(#f1ag2d89ez7vo3)" height="61.7031" style="stroke:#000000;stroke-width:2.0;" width="256" x="50" y="866.7344"/><rect fill="#FFFFFF" height="48.1875" style="stroke:none;stroke-width:1.0;" width="317" x="40" y="935.4375"/><rect fill="#FFFFFF" filter="url(#f1ag2d89ez7vo3)" height="18.3516" style="stroke:#000000;stroke-width:2.0;" width="277" x="70" y="958.2734"/><rect fill="#FFFFFF" height="466.1563" style="stroke:none;stroke-width:1.0;" width="400" x="30" y="1015.625"/><rect fill="#FFFFFF" filter="url(#f1ag2d89ez7vo3)" height="367.9688" style="stroke:#000000;stroke-width:2.0;" width="372" x="40" y="1081.8125"/><rect fill="#FFFFFF" height="159.8906" style="stroke:none;stroke-width:1.0;" width="372" x="40" y="1125.1641"/><rect fill="#FFFFFF" filter="url(#f1ag2d89ez7vo3)" height="105.0547" style="stroke:#000000;stroke-width:2.0;" width="352" x="50" y="1148"/><rect fill="#FFFFFF" height="116.5391" style="stroke:none;stroke-width:1.0;" width="372" x="40" y="1285.0547"/><rect fill="#FFFFFF" filter="url(#f1ag2d89ez7vo3)" height="61.7031" style="stroke:#000000;stroke-width:2.0;" width="256" x="50" y="1307.8906"/><rect fill="#FFFFFF" height="48.1875" style="stroke:none;stroke-width:1.0;" width="372" x="40" y="1401.5938"/><rect fill="#FFFFFF" filter="url(#f1ag2d89ez7vo3)" height="18.3516" style="stroke:#000000;stroke-width:2.0;" width="277" x="70" y="1424.4297"/><rect fill="#FFFFFF" height="73.1875" style="stroke:none;stroke-width:1.0;" width="400" x="30" y="1481.7813"/><rect fill="#FFFFFF" filter="url(#f1ag2d89ez7vo3)" height="18.3516" style="stroke:#000000;stroke-width:2.0;" width="277" x="70" y="1504.6172"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="105" x2="105" y1="41.6094" y2="1610.9688"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="448.5" x2="448.5" y1="41.6094" y2="1610.9688"/><rect fill="#FEFECE" filter="url(#f1ag2d89ez7vo3)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="86" x="60" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="67" y="26.5332">VariablePei</text><rect fill="#FEFECE" filter="url(#f1ag2d89ez7vo3)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="86" x="60" y="1609.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="72" x="67" y="1631.502">VariablePei</text><rect fill="#FEFECE" filter="url(#f1ag2d89ez7vo3)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="85" x="404.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="411.5" y="26.5332">KeyService</text><rect fill="#FEFECE" filter="url(#f1ag2d89ez7vo3)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="85" x="404.5" y="1609.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="71" x="411.5" y="1631.502">KeyService</text><rect fill="#FFFFFF" filter="url(#f1ag2d89ez7vo3)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="444" y="99.3125"/><path d="M10,58.6094 L83,58.6094 L83,66.6094 L73,76.6094 L10,76.6094 L10,58.6094 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="1510.3594" style="stroke:#000000;stroke-width:2.0;" width="493.5" x="10" y="58.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="28" x="25" y="73.1045">loop</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="174" x="98" y="72.0283">[if more variable keys available]</text><polygon fill="#A80036" points="432,95.3125,442,99.3125,432,103.3125,436,99.3125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="105" x2="438" y1="99.3125" y2="99.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="70" x="112" y="94.4561">VariableKey</text><polygon fill="#A80036" points="116,125.6641,106,129.6641,116,133.6641,112,129.6641" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="110" x2="448" y1="129.6641" y2="129.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="23" x="122" y="124.8076">Key</text><line style="stroke:#A80036;stroke-width:1.0;" x1="105" x2="147" y1="160.0156" y2="160.0156"/><line style="stroke:#A80036;stroke-width:1.0;" x1="147" x2="147" y1="160.0156" y2="173.0156"/><line style="stroke:#A80036;stroke-width:1.0;" x1="106" x2="147" y1="173.0156" y2="173.0156"/><polygon fill="#A80036" points="116,169.0156,106,173.0156,116,177.0156,112,173.0156" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="112" y="155.1592">HKDF_Expand(SHA256,Key,"HMAC_KEY")</text><line style="stroke:#A80036;stroke-width:1.0;" x1="105" x2="147" y1="203.3672" y2="203.3672"/><line style="stroke:#A80036;stroke-width:1.0;" x1="147" x2="147" y1="203.3672" y2="216.3672"/><line style="stroke:#A80036;stroke-width:1.0;" x1="106" x2="147" y1="216.3672" y2="216.3672"/><polygon fill="#A80036" points="116,212.3672,106,216.3672,116,220.3672,112,216.3672" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="330" x="112" y="198.5107">HMAC2(Key, HASH(Var1) || .. || HASH(VarN) || Counter2)</text><path d="M20,231.3672 L81,231.3672 L81,239.3672 L71,249.3672 L20,249.3672 L20,231.3672 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="1330.6016" style="stroke:#000000;stroke-width:2.0;" width="420" x="20" y="231.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="35" y="245.8623">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="108" x="96" y="244.7861">[check VarHmac(s)]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="20" x2="440" y1="275.7188" y2="275.7188"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="74" x="25" y="287.1377">[no VarHmac]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="105" x2="147" y1="312.9063" y2="312.9063"/><line style="stroke:#A80036;stroke-width:1.0;" x1="147" x2="147" y1="312.9063" y2="325.9063"/><line style="stroke:#A80036;stroke-width:1.0;" x1="106" x2="147" y1="325.9063" y2="325.9063"/><polygon fill="#A80036" points="116,321.9063,106,325.9063,116,329.9063,112,325.9063" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="179" x="112" y="308.0498">Construct VarHmac in memory</text><path d="M70,340.9063 L151,340.9063 L151,348.9063 L141,358.9063 L70,358.9063 L70,340.9063 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="18.3516" style="stroke:#000000;stroke-width:2.0;" width="256" x="70" y="340.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="36" x="85" y="355.4014">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="354.3252">[</text><text fill="#008000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="170" y="354.3252">exit loop with HMAC-Match]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="20" x2="440" y1="392.2578" y2="392.2578"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="290" x="25" y="403.6768">[one VarHmac: VarHmac(IN_DEL) or VarHmac(ADDED)]</text><path d="M40,414.0938 L101,414.0938 L101,422.0938 L91,432.0938 L40,432.0938 L40,414.0938 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="265.4297" style="stroke:#000000;stroke-width:2.0;" width="372" x="40" y="414.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="55" y="428.5889">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="109" x="116" y="427.5127">[check HMAC2 only]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="40" x2="412" y1="458.4453" y2="458.4453"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="84" x="45" y="469.8643">[HMAC2 match]</text><path d="M50,480.2813 L115,480.2813 L115,488.2813 L105,498.2813 L50,498.2813 L50,480.2813 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="61.7031" style="stroke:#000000;stroke-width:2.0;" width="352" x="50" y="480.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="20" x="65" y="494.7764">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="101" x="130" y="493.7002">[VarHmac(IN_DEL)]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="105" x2="147" y1="520.9844" y2="520.9844"/><line style="stroke:#A80036;stroke-width:1.0;" x1="147" x2="147" y1="520.9844" y2="533.9844"/><line style="stroke:#A80036;stroke-width:1.0;" x1="106" x2="147" y1="533.9844" y2="533.9844"/><polygon fill="#A80036" points="116,529.9844,106,533.9844,116,537.9844,112,533.9844" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="112" y="516.1279">Elevate VarHmac(IN_DEL) to VarHmac(ADDED)</text><path d="M70,555.9844 L151,555.9844 L151,563.9844 L141,573.9844 L70,573.9844 L70,555.9844 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="18.3516" style="stroke:#000000;stroke-width:2.0;" width="256" x="70" y="555.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="36" x="85" y="570.4795">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="569.4033">[</text><text fill="#008000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="170" y="569.4033">exit loop with HMAC-Match]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="40" x2="412" y1="607.3359" y2="607.3359"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="241" x="45" y="618.7549">[HMAC2 mis-match or Counter2 &gt; Counter1]</text><path d="M70,629.1719 L151,629.1719 L151,637.1719 L141,647.1719 L70,647.1719 L70,629.1719 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="18.3516" style="stroke:#000000;stroke-width:2.0;" width="277" x="70" y="629.1719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="36" x="85" y="643.667">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="642.5908">[</text><text fill="#FF0000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="172" x="170" y="642.5908">exit loop with HMAC-Mismatch]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="20" x2="440" y1="712.5234" y2="712.5234"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="313" x="25" y="723.9424">[two VarHmac(s): VarHmac(IN_DEL) and VarHmac(ADDED)]</text><path d="M30,734.3594 L91,734.3594 L91,742.3594 L81,752.3594 L30,752.3594 L30,734.3594 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="820.6094" style="stroke:#000000;stroke-width:2.0;" width="400" x="30" y="734.3594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="45" y="748.8545">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="192" x="106" y="747.7783">[check Counter1 against Counter2]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="30" x2="430" y1="778.7109" y2="778.7109"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="35" y="790.1299">[(Counter1 - Counter2) == 0]</text><path d="M40,800.5469 L101,800.5469 L101,808.5469 L91,818.5469 L40,818.5469 L40,800.5469 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="183.0781" style="stroke:#000000;stroke-width:2.0;" width="317" x="40" y="800.5469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="55" y="815.042">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="161" x="116" y="813.9658">[HMAC2 vs. VarHmac(ADDED)]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="40" x2="357" y1="844.8984" y2="844.8984"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="42" x="45" y="856.3174">[match]</text><path d="M50,866.7344 L131,866.7344 L131,874.7344 L121,884.7344 L50,884.7344 L50,866.7344 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="61.7031" style="stroke:#000000;stroke-width:2.0;" width="256" x="50" y="866.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="36" x="65" y="881.2295">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="4" x="146" y="880.1533">[</text><text fill="#008000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="150" y="880.1533">exit loop with HMAC-Match]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="105" x2="147" y1="907.4375" y2="907.4375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="147" x2="147" y1="907.4375" y2="920.4375"/><line style="stroke:#A80036;stroke-width:1.0;" x1="106" x2="147" y1="920.4375" y2="920.4375"/><polygon fill="#A80036" points="116,916.4375,106,920.4375,116,924.4375,112,920.4375" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="112" y="902.5811">Delete VarHmac(IN_DEL)</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="40" x2="357" y1="936.4375" y2="936.4375"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="67" x="45" y="947.8564">[mis-match]</text><path d="M70,958.2734 L151,958.2734 L151,966.2734 L141,976.2734 L70,976.2734 L70,958.2734 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="18.3516" style="stroke:#000000;stroke-width:2.0;" width="277" x="70" y="958.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="36" x="85" y="972.7686">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="971.6924">[</text><text fill="#FF0000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="172" x="170" y="971.6924">exit loop with HMAC-Mismatch]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="30" x2="430" y1="1016.625" y2="1016.625"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="152" x="35" y="1028.0439">[(Counter1 - Counter2) == 1]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="105" x2="147" y1="1053.8125" y2="1053.8125"/><line style="stroke:#A80036;stroke-width:1.0;" x1="147" x2="147" y1="1053.8125" y2="1066.8125"/><line style="stroke:#A80036;stroke-width:1.0;" x1="106" x2="147" y1="1066.8125" y2="1066.8125"/><polygon fill="#A80036" points="116,1062.8125,106,1066.8125,116,1070.8125,112,1066.8125" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="306" x="112" y="1048.9561">HMAC1(Key, HASH(Var1)||..||HASH(VarN)||Counter1)</text><path d="M40,1081.8125 L101,1081.8125 L101,1089.8125 L91,1099.8125 L40,1099.8125 L40,1081.8125 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="367.9688" style="stroke:#000000;stroke-width:2.0;" width="372" x="40" y="1081.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="55" y="1096.3076">alt</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="40" x2="412" y1="1126.1641" y2="1126.1641"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="180" x="45" y="1137.583">[HAMC2 match VarHmac(IN_DEL)]</text><path d="M50,1148 L131,1148 L131,1156 L121,1166 L50,1166 L50,1148 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="105.0547" style="stroke:#000000;stroke-width:2.0;" width="352" x="50" y="1148"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="36" x="65" y="1162.4951">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="4" x="146" y="1161.4189">[</text><text fill="#008000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="150" y="1161.4189">exit loop with HMAC-Match]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="105" x2="147" y1="1188.7031" y2="1188.7031"/><line style="stroke:#A80036;stroke-width:1.0;" x1="147" x2="147" y1="1188.7031" y2="1201.7031"/><line style="stroke:#A80036;stroke-width:1.0;" x1="106" x2="147" y1="1201.7031" y2="1201.7031"/><polygon fill="#A80036" points="116,1197.7031,106,1201.7031,116,1205.7031,112,1201.7031" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="148" x="112" y="1183.8467">Delete VarHmac(ADDED)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="105" x2="147" y1="1232.0547" y2="1232.0547"/><line style="stroke:#A80036;stroke-width:1.0;" x1="147" x2="147" y1="1232.0547" y2="1245.0547"/><line style="stroke:#A80036;stroke-width:1.0;" x1="106" x2="147" y1="1245.0547" y2="1245.0547"/><polygon fill="#A80036" points="116,1241.0547,106,1245.0547,116,1249.0547,112,1245.0547" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="278" x="112" y="1227.1982">Elevate VarHmac(IN_DEL) to VarHmac(ADDED)</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="40" x2="412" y1="1286.0547" y2="1286.0547"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="179" x="45" y="1297.4736">[HAMC1 match VarHmac(ADDED)]</text><path d="M50,1307.8906 L131,1307.8906 L131,1315.8906 L121,1325.8906 L50,1325.8906 L50,1307.8906 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="61.7031" style="stroke:#000000;stroke-width:2.0;" width="256" x="50" y="1307.8906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="36" x="65" y="1322.3857">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="4" x="146" y="1321.3096">[</text><text fill="#008000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="151" x="150" y="1321.3096">exit loop with HMAC-Match]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="105" x2="147" y1="1348.5938" y2="1348.5938"/><line style="stroke:#A80036;stroke-width:1.0;" x1="147" x2="147" y1="1348.5938" y2="1361.5938"/><line style="stroke:#A80036;stroke-width:1.0;" x1="106" x2="147" y1="1361.5938" y2="1361.5938"/><polygon fill="#A80036" points="116,1357.5938,106,1361.5938,116,1365.5938,112,1361.5938" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="147" x="112" y="1343.7373">Delete VarHmac(IN_DEL)</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="40" x2="412" y1="1402.5938" y2="1402.5938"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="67" x="45" y="1414.0127">[mis-match]</text><path d="M70,1424.4297 L151,1424.4297 L151,1432.4297 L141,1442.4297 L70,1442.4297 L70,1424.4297 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="18.3516" style="stroke:#000000;stroke-width:2.0;" width="277" x="70" y="1424.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="36" x="85" y="1438.9248">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="1437.8486">[</text><text fill="#FF0000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="172" x="170" y="1437.8486">exit loop with HMAC-Mismatch]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="30" x2="430" y1="1482.7813" y2="1482.7813"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="89" x="35" y="1494.2002">[all other cases]</text><path d="M70,1504.6172 L151,1504.6172 L151,1512.6172 L141,1522.6172 L70,1522.6172 L70,1504.6172 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="18.3516" style="stroke:#000000;stroke-width:2.0;" width="277" x="70" y="1504.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="36" x="85" y="1519.1123">break</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="4" x="166" y="1518.0361">[</text><text fill="#FF0000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="172" x="170" y="1518.0361">exit loop with HMAC-Mismatch]</text><!--MD5=[121f57f932d0887cf3cb597365582bbb]
@startuml Protected Variable Init Sequence
  loop if more variable keys available
    VariablePei -> KeyService ++ : VariableKey
    return Key

    VariablePei -> VariablePei: HKDF_Expand(SHA256,Key,"HMAC_KEY")
    VariablePei -> VariablePei: HMAC2(Key, HASH(Var1) || .. || HASH(VarN) || Counter2)

    alt check VarHmac(s)
    |||
    else no VarHmac
      VariablePei -> VariablePei: Construct VarHmac in memory
      break <font color=green>exit loop with HMAC-Match
      end
      |||
    else one VarHmac: VarHmac(IN_DEL) or VarHmac(ADDED)
      alt check HMAC2 only
      |||
      else HMAC2 match
        opt VarHmac(IN_DEL)
          VariablePei -> VariablePei: Elevate VarHmac(IN_DEL) to VarHmac(ADDED)
        end
        break <font color=green>exit loop with HMAC-Match
        end
        |||
      else HMAC2 mis-match or Counter2 > Counter1
        break <font color=red>exit loop with HMAC-Mismatch
        end
        |||
      end
      |||
    else two VarHmac(s): VarHmac(IN_DEL) and VarHmac(ADDED)
      alt check Counter1 against Counter2
        |||
      else (Counter1 - Counter2) == 0
        alt HMAC2 vs. VarHmac(ADDED)
          |||
        else match
          break <font color=green>exit loop with HMAC-Match
            VariablePei -> VariablePei: Delete VarHmac(IN_DEL)
          end
        else mis-match
          break <font color=red>exit loop with HMAC-Mismatch
          end
        end
        |||
      else (Counter1 - Counter2) == 1
        VariablePei -> VariablePei: HMAC1(Key, HASH(Var1)||..||HASH(VarN)||Counter1)
        alt
          |||
        else HAMC2 match VarHmac(IN_DEL)
          break <font color=green>exit loop with HMAC-Match
            VariablePei -> VariablePei: Delete VarHmac(ADDED)
            VariablePei -> VariablePei: Elevate VarHmac(IN_DEL) to VarHmac(ADDED)
          end
          |||
        else HAMC1 match VarHmac(ADDED)
          break <font color=green>exit loop with HMAC-Match
            VariablePei -> VariablePei: Delete VarHmac(IN_DEL)
          end
          |||
        else mis-match
          break <font color=red>exit loop with HMAC-Mismatch
          end
        end
        |||
      else all other cases
        break <font color=red>exit loop with HMAC-Mismatch
        end
        |||
      end
    end
  end

  |||
@enduml

PlantUML version 1.2020.26(Tue Dec 22 01:45:07 CST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: Cp1252
Language: en
Country: US
--></g></svg>