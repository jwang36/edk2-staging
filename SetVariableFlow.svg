<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1556px" preserveAspectRatio="none" style="width:757px;height:1556px;" version="1.1" viewBox="0 0 757 1556" width="757px" zoomAndPan="magnify"><defs><filter height="300%" id="f1e964r504mqv2" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFFFFF" filter="url(#f1e964r504mqv2)" height="14" style="stroke:#A80036;stroke-width:1.0;" width="10" x="638" y="1179.4766"/><rect fill="#FFFFFF" filter="url(#f1e964r504mqv2)" height="14" style="stroke:#A80036;stroke-width:1.0;" width="10" x="638" y="1258.1797"/><rect fill="#FFFFFF" filter="url(#f1e964r504mqv2)" height="14" style="stroke:#A80036;stroke-width:1.0;" width="10" x="638" y="1415.5859"/><rect fill="#FFFFFF" filter="url(#f1e964r504mqv2)" height="14" style="stroke:#A80036;stroke-width:1.0;" width="10" x="696.5" y="856.3125"/><rect fill="#FFFFFF" filter="url(#f1e964r504mqv2)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="696.5" y="1075.4219"/><rect fill="#FFFFFF" filter="url(#f1e964r504mqv2)" height="14" style="stroke:#A80036;stroke-width:1.0;" width="10" x="696.5" y="1336.8828"/><rect fill="#FFFFFF" filter="url(#f1e964r504mqv2)" height="594.2969" style="stroke:#000000;stroke-width:2.0;" width="623" x="117.5" y="102.9609"/><rect fill="#FFFFFF" height="279.2969" style="stroke:none;stroke-width:1.0;" width="623" x="117.5" y="146.3125"/><rect fill="#FFFFFF" height="271.6484" style="stroke:none;stroke-width:1.0;" width="623" x="117.5" y="425.6094"/><rect fill="#FFFFFF" filter="url(#f1e964r504mqv2)" height="61.7031" style="stroke:#000000;stroke-width:2.0;" width="229.5" x="117.5" y="984.3672"/><line style="stroke:#A80036;stroke-width:1.0;" x1="29" x2="29" y1="41.6094" y2="732.2578"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="29" x2="29" y1="732.2578" y2="760.2578"/><line style="stroke:#A80036;stroke-width:1.0;" x1="29" x2="29" y1="760.2578" y2="1512.2891"/><line style="stroke:#A80036;stroke-width:1.0;" x1="177.5" x2="177.5" y1="41.6094" y2="732.2578"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="177.5" x2="177.5" y1="732.2578" y2="760.2578"/><line style="stroke:#A80036;stroke-width:1.0;" x1="177.5" x2="177.5" y1="760.2578" y2="1512.2891"/><line style="stroke:#A80036;stroke-width:1.0;" x1="642.5" x2="642.5" y1="41.6094" y2="732.2578"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="642.5" x2="642.5" y1="732.2578" y2="760.2578"/><line style="stroke:#A80036;stroke-width:1.0;" x1="642.5" x2="642.5" y1="760.2578" y2="1512.2891"/><line style="stroke:#A80036;stroke-width:1.0;" x1="701.5" x2="701.5" y1="41.6094" y2="732.2578"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:1.0,4.0;" x1="701.5" x2="701.5" y1="732.2578" y2="760.2578"/><line style="stroke:#A80036;stroke-width:1.0;" x1="701.5" x2="701.5" y1="760.2578" y2="1512.2891"/><rect fill="#FEFECE" filter="url(#f1e964r504mqv2)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="44" x="5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="12" y="26.5332">UEFI</text><rect fill="#FEFECE" filter="url(#f1e964r504mqv2)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="44" x="5" y="1511.2891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="30" x="12" y="1532.8223">UEFI</text><rect fill="#FEFECE" filter="url(#f1e964r504mqv2)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="97" x="127.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="134.5" y="26.5332">VariableSmm</text><rect fill="#FEFECE" filter="url(#f1e964r504mqv2)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="97" x="127.5" y="1511.2891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="83" x="134.5" y="1532.8223">VariableSmm</text><rect fill="#FEFECE" filter="url(#f1e964r504mqv2)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="35" x="623.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="21" x="630.5" y="26.5332">SPI</text><rect fill="#FEFECE" filter="url(#f1e964r504mqv2)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="35" x="623.5" y="1511.2891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="21" x="630.5" y="1532.8223">SPI</text><rect fill="#FEFECE" filter="url(#f1e964r504mqv2)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="54" x="672.5" y="5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="40" x="679.5" y="26.5332">RPMC</text><rect fill="#FEFECE" filter="url(#f1e964r504mqv2)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="54" x="672.5" y="1511.2891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="40" x="679.5" y="1532.8223">RPMC</text><rect fill="#FFFFFF" filter="url(#f1e964r504mqv2)" height="14" style="stroke:#A80036;stroke-width:1.0;" width="10" x="638" y="1179.4766"/><rect fill="#FFFFFF" filter="url(#f1e964r504mqv2)" height="14" style="stroke:#A80036;stroke-width:1.0;" width="10" x="638" y="1258.1797"/><rect fill="#FFFFFF" filter="url(#f1e964r504mqv2)" height="14" style="stroke:#A80036;stroke-width:1.0;" width="10" x="638" y="1415.5859"/><rect fill="#FFFFFF" filter="url(#f1e964r504mqv2)" height="14" style="stroke:#A80036;stroke-width:1.0;" width="10" x="696.5" y="856.3125"/><rect fill="#FFFFFF" filter="url(#f1e964r504mqv2)" height="30.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="696.5" y="1075.4219"/><rect fill="#FFFFFF" filter="url(#f1e964r504mqv2)" height="14" style="stroke:#A80036;stroke-width:1.0;" width="10" x="696.5" y="1336.8828"/><rect fill="#EEEEEE" filter="url(#f1e964r504mqv2)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="750.5" x="0" y="72.7852"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="750.5" y1="72.7852" y2="72.7852"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="750.5" y1="75.7852" y2="75.7852"/><rect fill="#EEEEEE" filter="url(#f1e964r504mqv2)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="222" x="264.25" y="61.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="204" x="270.25" y="79.1045">VariableWriteProtocolCallback()</text><path d="M117.5,102.9609 L178.5,102.9609 L178.5,110.9609 L168.5,120.9609 L117.5,120.9609 L117.5,102.9609 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="594.2969" style="stroke:#000000;stroke-width:2.0;" width="623" x="117.5" y="102.9609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="16" x="132.5" y="117.4561">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="92" x="193.5" y="116.3799">[Write init mode]</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="117.5" x2="740.5" y1="147.3125" y2="147.3125"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="181" x="122.5" y="158.7314">[Variable recovery/factory mode]</text><polygon fill="#A80036" points="689.5,180.5,699.5,184.5,689.5,188.5,693.5,184.5" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="695.5" y1="184.5" y2="184.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="185" y="179.6436">IncrementMonotonicCounter(1)</text><polygon fill="#A80036" points="689.5,210.8516,699.5,214.8516,689.5,218.8516,693.5,214.8516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="695.5" y1="214.8516" y2="214.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="185" y="209.9951">IncrementMonotonicCounter(2)</text><polygon fill="#A80036" points="689.5,241.2031,699.5,245.2031,689.5,249.2031,693.5,245.2031" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="695.5" y1="245.2031" y2="245.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="185" y="240.3467">RequestMonotonicCounter(2)</text><polygon fill="#A80036" points="189,271.5547,179,275.5547,189,279.5547,185,275.5547" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="183" x2="700.5" y1="275.5547" y2="275.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="195" y="270.6982">Counter2</text><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="220" y1="305.9063" y2="305.9063"/><line style="stroke:#A80036;stroke-width:1.0;" x1="220" x2="220" y1="305.9063" y2="318.9063"/><line style="stroke:#A80036;stroke-width:1.0;" x1="179" x2="220" y1="318.9063" y2="318.9063"/><polygon fill="#A80036" points="189,314.9063,179,318.9063,189,322.9063,185,318.9063" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="303" x="185" y="301.0498">HMAC(Key, HASH(Var1)||..||(HASH(VarN)||Counter2)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="220" y1="349.2578" y2="349.2578"/><line style="stroke:#A80036;stroke-width:1.0;" x1="220" x2="220" y1="349.2578" y2="362.2578"/><line style="stroke:#A80036;stroke-width:1.0;" x1="179" x2="220" y1="362.2578" y2="362.2578"/><polygon fill="#A80036" points="189,358.2578,179,362.2578,189,366.2578,185,362.2578" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="183" x="185" y="344.4014">Construct VarHmac with HMAC</text><polygon fill="#A80036" points="631,388.6094,641,392.6094,631,396.6094,635,392.6094" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="637" y1="392.6094" y2="392.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="184" x="185" y="387.7529">Flush all variabes to NV storage</text><line style="stroke:#000000;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="117.5" x2="740.5" y1="426.6094" y2="426.6094"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="148" x="122.5" y="438.0283">[Normal variable init mode]</text><polygon fill="#A80036" points="689.5,459.7969,699.5,463.7969,689.5,467.7969,693.5,463.7969" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="695.5" y1="463.7969" y2="463.7969"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="168" x="185" y="458.9404">RequestMonotonicCounter(2)</text><polygon fill="#A80036" points="189,490.1484,179,494.1484,189,498.1484,185,494.1484" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="183" x2="700.5" y1="494.1484" y2="494.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="52" x="195" y="489.292">Counter2</text><polygon fill="#A80036" points="689.5,520.5,699.5,524.5,689.5,528.5,693.5,524.5" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="695.5" y1="524.5" y2="524.5"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="185" y="519.6436">IncrementMonotonicCounter(1)</text><polygon fill="#A80036" points="631,550.8516,641,554.8516,631,558.8516,635,554.8516" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="637" y1="554.8516" y2="554.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="207" x="185" y="549.9951">UpdateState(VarHmac.old, IN_DEL)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="220" y1="585.2031" y2="585.2031"/><line style="stroke:#A80036;stroke-width:1.0;" x1="220" x2="220" y1="585.2031" y2="598.2031"/><line style="stroke:#A80036;stroke-width:1.0;" x1="179" x2="220" y1="598.2031" y2="598.2031"/><polygon fill="#A80036" points="189,594.2031,179,598.2031,189,602.2031,185,598.2031" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="314" x="185" y="580.3467">HMAC(Key, HASH(Var1)||..||HASH(VarN)||Counter2+1)</text><polygon fill="#A80036" points="631,624.5547,641,628.5547,631,632.5547,635,628.5547" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="637" y1="628.5547" y2="628.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="212" x="185" y="623.6982">AddVariable(VarHmac.new, ADDED)</text><polygon fill="#A80036" points="689.5,654.9063,699.5,658.9063,689.5,662.9063,693.5,658.9063" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="695.5" y1="658.9063" y2="658.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="177" x="185" y="654.0498">IncrementMonotonicCounter(2)</text><polygon fill="#A80036" points="631,685.2578,641,689.2578,631,693.2578,635,689.2578" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="637" y1="689.2578" y2="689.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="188" x="185" y="684.4014">UpdateState(VarHmac.old, DEL)</text><rect fill="#EEEEEE" filter="url(#f1e964r504mqv2)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="750.5" x="0" y="717.2578"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="750.5" y1="717.2578" y2="717.2578"/><line style="stroke:#000000;stroke-width:1.0;" x1="0" x2="750.5" y1="720.2578" y2="720.2578"/><polygon fill="#A80036" points="166,778.6094,176,782.6094,166,786.6094,170,782.6094" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="29" x2="172" y1="782.6094" y2="782.6094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="71" x="36" y="777.7529">SetVariable(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50" x="107" y="777.7529">VarNew</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="157" y="777.7529">)</text><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="220" y1="812.9609" y2="812.9609"/><line style="stroke:#A80036;stroke-width:1.0;" x1="220" x2="220" y1="812.9609" y2="825.9609"/><line style="stroke:#A80036;stroke-width:1.0;" x1="179" x2="220" y1="825.9609" y2="825.9609"/><polygon fill="#A80036" points="189,821.9609,179,825.9609,189,829.9609,185,825.9609" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="119" x="185" y="808.1045">Calc HASH(VarNew)</text><polygon fill="#A80036" points="684.5,852.3125,694.5,856.3125,684.5,860.3125,688.5,856.3125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="690.5" y1="856.3125" y2="856.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="185" y="851.4561">IncrementMonotonicCounter(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="351" y="851.4561">1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="358" y="851.4561">)</text><polygon fill="#A80036" points="189,866.3125,179,870.3125,189,874.3125,185,870.3125" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="183" x2="700.5" y1="870.3125" y2="870.3125"/><rect fill="#FBFB77" filter="url(#f1e964r504mqv2)" height="24" style="stroke:#A80036;stroke-width:1.0;" width="198" x="183" y="883.3125"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="187" y="900.8076">[A] Incremented RPMC Counter1</text><polygon fill="#A80036" points="631,931.0156,641,935.0156,631,939.0156,635,935.0156" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="637" y1="935.0156" y2="935.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="185" y="930.1592">UpdateState(VarHmac.old,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="45" x="344" y="930.1592">IN_DEL</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="389" y="930.1592">)</text><rect fill="#FBFB77" filter="url(#f1e964r504mqv2)" height="24" style="stroke:#A80036;stroke-width:1.0;" width="263" x="183" y="948.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="255" x="187" y="965.5107">[B] Marked VarHmac as In-Delete-Transition</text><path d="M117.5,984.3672 L182.5,984.3672 L182.5,992.3672 L172.5,1002.3672 L117.5,1002.3672 L117.5,984.3672 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="61.7031" style="stroke:#000000;stroke-width:2.0;" width="229.5" x="117.5" y="984.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="20" x="132.5" y="998.8623">opt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="124" x="197.5" y="997.7861">[If encryption enabled]</text><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="220" y1="1025.0703" y2="1025.0703"/><line style="stroke:#A80036;stroke-width:1.0;" x1="220" x2="220" y1="1025.0703" y2="1038.0703"/><line style="stroke:#A80036;stroke-width:1.0;" x1="179" x2="220" y1="1038.0703" y2="1038.0703"/><polygon fill="#A80036" points="189,1034.0703,179,1038.0703,189,1042.0703,185,1038.0703" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="96" x="185" y="1020.2139">EncryptVariable(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50" x="281" y="1020.2139">VarNew</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="331" y="1020.2139">)</text><polygon fill="#A80036" points="684.5,1071.4219,694.5,1075.4219,684.5,1079.4219,688.5,1075.4219" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="690.5" y1="1075.4219" y2="1075.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="157" x="185" y="1070.5654">RequestMonotonicCounter(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="342" y="1070.5654">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="349" y="1070.5654">)</text><polygon fill="#A80036" points="189,1101.7734,179,1105.7734,189,1109.7734,185,1105.7734" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="183" x2="700.5" y1="1105.7734" y2="1105.7734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="57" x="195" y="1100.917">Counter2</text><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="220" y1="1136.125" y2="1136.125"/><line style="stroke:#A80036;stroke-width:1.0;" x1="220" x2="220" y1="1136.125" y2="1149.125"/><line style="stroke:#A80036;stroke-width:1.0;" x1="179" x2="220" y1="1149.125" y2="1149.125"/><polygon fill="#A80036" points="189,1145.125,179,1149.125,189,1153.125,185,1149.125" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="307" x="185" y="1131.2686">HMAC(Key, HASH(Var1) || .. || HASH(VarN) || HASH(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="50" x="492" y="1131.2686">VarNew</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="14" x="542" y="1131.2686">) ||</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="72" x="560" y="1131.2686">Counter2+1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="632" y="1131.2686">)</text><polygon fill="#A80036" points="626,1175.4766,636,1179.4766,626,1183.4766,630,1179.4766" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="632" y1="1179.4766" y2="1179.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="159" x="185" y="1174.6201">AddVariable(VarHmac.new,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="44" x="348" y="1174.6201">ADDED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="392" y="1174.6201">)</text><polygon fill="#A80036" points="189,1189.4766,179,1193.4766,189,1197.4766,185,1193.4766" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="183" x2="642" y1="1193.4766" y2="1193.4766"/><rect fill="#FBFB77" filter="url(#f1e964r504mqv2)" height="24" style="stroke:#A80036;stroke-width:1.0;" width="306" x="183" y="1206.4766"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="298" x="187" y="1223.9717">[C] Force added a new VarHmac with state ADDED</text><polygon fill="#A80036" points="626,1254.1797,636,1258.1797,626,1262.1797,630,1258.1797" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="632" y1="1258.1797" y2="1258.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="123" x="185" y="1253.3232">AddVariable(VarNew,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="44" x="312" y="1253.3232">ADDED</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="356" y="1253.3232">)</text><polygon fill="#A80036" points="189,1268.1797,179,1272.1797,189,1276.1797,185,1272.1797" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="183" x2="642" y1="1272.1797" y2="1272.1797"/><rect fill="#FBFB77" filter="url(#f1e964r504mqv2)" height="24" style="stroke:#A80036;stroke-width:1.0;" width="174" x="183" y="1285.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="187" y="1302.6748">[D] Added requested variable</text><polygon fill="#A80036" points="684.5,1332.8828,694.5,1336.8828,684.5,1340.8828,688.5,1336.8828" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="690.5" y1="1336.8828" y2="1336.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="166" x="185" y="1332.0264">IncrementMonotonicCounter(</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="7" x="351" y="1332.0264">2</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="358" y="1332.0264">)</text><polygon fill="#A80036" points="189,1346.8828,179,1350.8828,189,1354.8828,185,1350.8828" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="183" x2="700.5" y1="1350.8828" y2="1350.8828"/><rect fill="#FBFB77" filter="url(#f1e964r504mqv2)" height="24" style="stroke:#A80036;stroke-width:1.0;" width="198" x="183" y="1363.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="190" x="187" y="1381.3779">[E] Incremented RPMC Counter2</text><polygon fill="#A80036" points="626,1411.5859,636,1415.5859,626,1419.5859,630,1415.5859" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="178" x2="632" y1="1415.5859" y2="1415.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="155" x="185" y="1410.7295">UpdateState(VarHmac.old,</text><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="25" x="344" y="1410.7295">DEL</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="4" x="369" y="1410.7295">)</text><polygon fill="#A80036" points="189,1425.5859,179,1429.5859,189,1433.5859,185,1429.5859" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="183" x2="642" y1="1429.5859" y2="1429.5859"/><rect fill="#FBFB77" filter="url(#f1e964r504mqv2)" height="24" style="stroke:#A80036;stroke-width:1.0;" width="391" x="183" y="1442.5859"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="383" x="187" y="1460.0811">[F] Marked old copy of VarHmac as Deleted (deleted permanently)</text><polygon fill="#A80036" points="40,1490.2891,30,1494.2891,40,1498.2891,36,1494.2891" style="stroke:#A80036;stroke-width:1.0;"/><line style="stroke:#A80036;stroke-width:1.0;" x1="34" x2="177" y1="1494.2891" y2="1494.2891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="90" x="46" y="1489.4326">EFI_SUCCESS</text><!--MD5=[c419e9bfb1bd73a7bfed88c7a2523af2]
@startuml SetVariable Flow
participant UEFI
participant VariableSmm
participant SPI
participant RPMC

  == VariableWriteProtocolCallback() ==
    alt Write init mode
      |||
    else Variable recovery/factory mode
      VariableSmm -> RPMC : IncrementMonotonicCounter(1)
      VariableSmm -> RPMC : IncrementMonotonicCounter(2)
      VariableSmm -> RPMC : RequestMonotonicCounter(2)
      RPMC - -> VariableSmm : Counter2
      VariableSmm -> VariableSmm : HMAC(Key, HASH(Var1)||..||(HASH(VarN)||Counter2)
      VariableSmm -> VariableSmm : Construct VarHmac with HMAC
      VariableSmm -> SPI : Flush all variabes to NV storage
      |||
    else Normal variable init mode
      VariableSmm -> RPMC : RequestMonotonicCounter(2)
      RPMC - -> VariableSmm : Counter2
      VariableSmm -> RPMC : IncrementMonotonicCounter(1)
      VariableSmm -> SPI : UpdateState(VarHmac.old, IN_DEL)
      VariableSmm -> VariableSmm : HMAC(Key, HASH(Var1)||..||HASH(VarN)||Counter2+1)
      VariableSmm -> SPI : AddVariable(VarHmac.new, ADDED)
      VariableSmm -> RPMC : IncrementMonotonicCounter(2)
      VariableSmm -> SPI : UpdateState(VarHmac.old, DEL)
    end
  ====

  ...
  UEFI -> VariableSmm: SetVariable(**VarNew**)

  VariableSmm -> VariableSmm: Calc HASH(VarNew)

  VariableSmm -> RPMC ++: IncrementMonotonicCounter(**1**)
  return
  rnote right of VariableSmm: [A] Incremented RPMC Counter1

  VariableSmm -> SPI : UpdateState(VarHmac.old, **IN_DEL**)
  rnote right of VariableSmm: [B] Marked VarHmac as In-Delete-Transition

  opt If encryption enabled
    VariableSmm -> VariableSmm : EncryptVariable(**VarNew**)
  end

  VariableSmm -> RPMC ++: RequestMonotonicCounter(**2**)
  return **Counter2**

  VariableSmm -> VariableSmm: HMAC(Key, HASH(Var1) || .. || HASH(VarN) || HASH(**VarNew**) || **Counter2+1**)
  VariableSmm -> SPI ++ : AddVariable(VarHmac.new, **ADDED**)
  return
  rnote right of VariableSmm: [C] Force added a new VarHmac with state ADDED

  VariableSmm -> SPI ++ : AddVariable(VarNew, **ADDED**)
  return
  rnote right of VariableSmm: [D] Added requested variable

  VariableSmm -> RPMC ++ : IncrementMonotonicCounter(**2**)
  return
  rnote right of VariableSmm: [E] Incremented RPMC Counter2

  VariableSmm -> SPI ++: UpdateState(VarHmac.old, **DEL**)
  return
  rnote right of VariableSmm: [F] Marked old copy of VarHmac as Deleted (deleted permanently)

  VariableSmm -> UEFI: EFI_SUCCESS
@enduml

PlantUML version 1.2020.26(Tue Dec 22 01:45:07 CST 2020)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: Cp1252
Language: en
Country: US
--></g></svg>